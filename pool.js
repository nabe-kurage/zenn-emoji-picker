// ========= pool.js =========

// 技術系・凡庸アイコンのブラックリスト（sub用）
export const BLACKLIST = new Set([
  "💻",
  "🖥️",
  "📱",
  "📲",
  "🧠",
  "🤖",
  "⚙️",
  "🔧",
  "🛠️",
  "🧩",
  "🖊️",
  "📝",
  "🔍",
  "🔎",
  "🎨",
  "💡",
  "✏️",
  "📚",
  "🚀",
]);

// 国旗検出（Regional Indicator 2文字の組み合わせ）
const isFlag = (s) => {
  if (!s) return false;
  const chars = Array.from(s);
  for (let i = 0; i < chars.length - 1; i++) {
    const cp1 = chars[i].codePointAt(0);
    const cp2 = chars[i + 1].codePointAt(0);
    const isRI1 = cp1 >= 0x1f1e6 && cp1 <= 0x1f1ff;
    const isRI2 = cp2 >= 0x1f1e6 && cp2 <= 0x1f1ff;
    if (isRI1 && isRI2) return true;
  }
  return false;
};

// カテゴリ分け（必要に応じて増減OK）
export const CATEGORIES = {
  globe: ["🌍", "🌎", "🌏", "🌐"],
  mountain: ["🏔️", "⛰️", "🌋", "🗻"],
  buildings: [
    "🏕️",
    "🏖️",
    "🏜️",
    "🏝️",
    "🏞️",
    "🏟️",
    "🏛️",
    "🏗️",
    "🧱",
    "🏘️",
    "🏙️",
    "🏚️",
    "🏠",
    "🏡",
    "🏢",
    "🏣",
    "🏤",
    "🏥",
    "🏦",
    "🏨",
    "🏩",
    "🏪",
    "🏫",
    "🏬",
    "🏭",
    "🏯",
    "🏰",
    "💒",
    "🗼",
    "🗽",
    "⛪",
    "🕌",
    "🛕",
    "🕍",
    "⛩️",
    "🕋",
  ],
  transport: [
    "🚂",
    "🚃",
    "🚄",
    "🚅",
    "🚆",
    "🚇",
    "🚈",
    "🚉",
    "🚊",
    "🚝",
    "🚞",
    "🚋",
    "🚌",
    "🚍",
    "🚎",
    "🚐",
    "🚑",
    "🚒",
    "🚓",
    "🚔",
    "🚕",
    "🚖",
    "🚗",
    "🚘",
    "🚙",
    "🚚",
    "🚛",
    "🚜",
    "🏎️",
    "🏍️",
    "🛵",
    "🦽",
    "🦼",
    "🛺",
    "🚲",
    "🛴",
    "🛹",
    "🛼",
    "🚏",
    "🛣️",
    "🛤️",
    "🛢️",
    "⛽",
    "🚨",
    "🚥",
    "🚦",
    "🛑",
    "🚧",
    "⚓",
    "⛵",
    "🛶",
    "🚤",
    "🛳️",
    "⛴️",
    "🛥️",
    "🚢",
    "✈️",
    "🛩️",
    "🛫",
    "🛬",
    "🪂",
    "💺",
    "🚁",
    "🚟",
    "🚠",
    "🚡",
    "🛰️",
    "🛸",
  ],
  nature_plants: [
    "🌱",
    "🌲",
    "🌳",
    "🌴",
    "🌵",
    "🌾",
    "🌿",
    "☘️",
    "🍀",
    "🍁",
    "🍂",
    "🍃",
    "🪴",
    "🌷",
    "🌸",
    "🌹",
    "🌺",
    "🌻",
    "🌼",
    "🌞",
    "🌝",
    "🌚",
    "🌙",
    "⭐",
    "🌟",
    "💫",
    "✨",
    "⚡",
    "☀️",
    "⛅",
    "🌤️",
    "🌥️",
    "☁️",
    "🌦️",
    "🌧️",
    "⛈️",
    "🌩️",
    "🌨️",
    "❄️",
    "☃️",
    "⛄",
    "🌬️",
    "💨",
    "🌪️",
    "🌫️",
    "🌊",
    "💧",
    "💦",
    "☔",
    "🌈",
  ],
  animals: [
    "🐵",
    "🐒",
    "🦍",
    "🦧",
    "🐶",
    "🐕",
    "🦮",
    "🐕‍🦺",
    "🐩",
    "🐺",
    "🦊",
    "🦝",
    "🐱",
    "🐈",
    "🐈‍⬛",
    "🦁",
    "🐯",
    "🐅",
    "🐆",
    "🐴",
    "🐎",
    "🦄",
    "🦓",
    "🦌",
    "🦬",
    "🐮",
    "🐂",
    "🐃",
    "🐄",
    "🐷",
    "🐖",
    "🐗",
    "🐏",
    "🐑",
    "🐐",
    "🐪",
    "🐫",
    "🦙",
    "🦒",
    "🐘",
    "🦣",
    "🦏",
    "🦛",
    "🐭",
    "🐁",
    "🐀",
    "🐹",
    "🐰",
    "🐇",
    "🐿️",
    "🦫",
    "🦔",
    "🦇",
    "🐻",
    "🐻‍❄️",
    "🐨",
    "🐼",
    "🦥",
    "🦦",
    "🦨",
    "🦘",
    "🦡",
    "🐾",
    "🦃",
    "🐔",
    "🐓",
    "🐣",
    "🐤",
    "🐥",
    "🐦",
    "🐧",
    "🕊️",
    "🦅",
    "🦆",
    "🦢",
    "🦉",
    "🦤",
    "🪶",
    "🦩",
    "🦚",
    "🦜",
    "🐸",
    "🐊",
    "🐢",
    "🦎",
    "🐍",
    "🐲",
    "🐉",
    "🦕",
    "🦖",
    "🐳",
    "🐋",
    "🐬",
    "🦭",
    "🐟",
    "🐠",
    "🐡",
    "🦈",
    "🐙",
    "🐚",
    "🪸",
    "🪼",
    "🦀",
    "🦞",
    "🦐",
    "🦑",
    "🪱",
    "🐌",
    "🦋",
    "🐛",
    "🐜",
    "🐝",
    "🪲",
    "🐞",
    "🪳",
    "🪰",
  ],
  food_drink: [
    "🍏",
    "🍎",
    "🍐",
    "🍊",
    "🍋",
    "🍌",
    "🍉",
    "🍇",
    "🍓",
    "🫐",
    "🍈",
    "🍒",
    "🍑",
    "🥭",
    "🍍",
    "🥥",
    "🥝",
    "🍅",
    "🍆",
    "🥑",
    "🥦",
    "🥬",
    "🥒",
    "🌶️",
    "🫑",
    "🌽",
    "🥕",
    "🫒",
    "🧄",
    "🧅",
    "🥔",
    "🍠",
    "🥐",
    "🥯",
    "🍞",
    "🥖",
    "🥨",
    "🧀",
    "🥚",
    "🍳",
    "🧈",
    "🥞",
    "🧇",
    "🥓",
    "🥩",
    "🍗",
    "🍖",
    "🌭",
    "🍔",
    "🍟",
    "🍕",
    "🫓",
    "🥪",
    "🥙",
    "🧆",
    "🌮",
    "🌯",
    "🫔",
    "🥗",
    "🥘",
    "🫛",
    "🥫",
    "🍝",
    "🍜",
    "🍲",
    "🍛",
    "🍣",
    "🍱",
    "🥟",
    "🦪",
    "🍤",
    "🍙",
    "🍚",
    "🍘",
    "🍥",
    "🥠",
    "🥮",
    "🍢",
    "🍡",
    "🍧",
    "🍨",
    "🍦",
    "🥧",
    "🍰",
    "🎂",
    "🧁",
    "🍮",
    "🍭",
    "🍬",
    "🍫",
    "🍿",
    "🍩",
    "🍪",
    "🌰",
    "🥜",
    "🫘",
    "🍯",
    "🥛",
    "🍼",
    "☕",
    "🍵",
    "🫖",
    "🍶",
    "🍺",
    "🍻",
    "🥂",
    "🍷",
    "🥃",
    "🍸",
    "🍹",
    "🧉",
    "🍾",
  ],
  objects: [
    "⌛",
    "⏳",
    "⌚",
    "⏰",
    "⏱️",
    "⏲️",
    "🕰️",
    "🕛",
    "⚖️",
    "🪙",
    "💰",
    "💴",
    "💵",
    "💶",
    "💷",
    "💸",
    "💳",
    "🧾",
    "🔦",
    "🏮",
    "🪔",
    "☎️",
    "📞",
    "📟",
    "📠",
    "📺",
    "📻",
    "🎙️",
    "🎚️",
    "🎛️",
    "📡",
    "🔋",
    "🔌",
    "🖨️",
    "⌨️",
    "🖱️",
    "🖲️",
    "💽",
    "💾",
    "🧮",
    "🎥",
    "🎞️",
    "📽️",
    "🎬",
    "📷",
    "📸",
    "📹",
    "📼",
    "🕯️",
    "💄",
    "💋",
    "👓",
    "🕶️",
    "🥽",
    "🥼",
    "🦺",
    "👔",
    "👕",
    "👖",
    "🧣",
    "🧤",
    "🧥",
    "🧦",
    "👗",
    "👘",
    "🥻",
    "🩱",
    "🩲",
    "🩳",
    "👙",
    "👚",
    "👛",
    "👜",
    "👝",
    "🛍️",
    "🎒",
    "🩴",
    "👞",
    "👟",
    "🥾",
    "🥿",
    "👠",
    "👡",
    "🩰",
    "👢",
    "👑",
    "👒",
    "🎩",
    "🎓",
    "🧢",
    "🪖",
    "⛑️",
    "📿",
    "💍",
    "💎",
  ],
  symbols: [
    "❤️",
    "🧡",
    "💛",
    "💚",
    "💙",
    "💜",
    "🖤",
    "🤍",
    "🤎",
    "❤️‍🔥",
    "❤️‍🩹",
    "💔",
    "❣️",
    "💕",
    "💞",
    "💓",
    "💗",
    "💖",
    "💘",
    "💝",
    "💟",
    "☮️",
    "✝️",
    "☪️",
    "🕉️",
    "☸️",
    "✡️",
    "🔯",
    "🪯",
    "☦️",
    "🛐",
    "⛎",
    "♈",
    "♉",
    "♊",
    "♋",
    "♌",
    "♍",
    "♎",
    "♏",
    "♐",
    "♑",
    "♒",
    "♓",
    "🆔",
    "⚛️",
    "🉑",
    "☢️",
    "☣️",
    "📴",
    "📳",
    "🈶",
    "🈚",
    "🈸",
    "🈺",
    "🈷️",
    "✴️",
    "🆚",
    "💠",
    "♻️",
    "🔱",
    "📛",
    "🔰",
    "⭕",
    "❌",
    "❎",
    "➕",
    "➖",
    "➗",
    "➰",
    "➿",
    "〽️",
    "✳️",
    "❇️",
    "©️",
    "®️",
    "™️",
  ],
};

// シャッフル
const shuffle = (arr, rnd = Math.random) => {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(rnd() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
};

/**
 * 各カテゴリから「1/3だけ」（端数切り上げ、最低1つ）取り出して WILDCARD_POOL を作成
 * - ブラックリスト／国旗を除外
 * - カテゴリ内はシャッフルして上から選ぶ
 * - 返す配列自体もシャッフル
 */
export function makeWildcardPoolOneThird({ rnd = Math.random } = {}) {
  const emoji2cat = {};
  Object.entries(CATEGORIES).forEach(([name, arr]) => {
    for (const e of arr) emoji2cat[e] = name;
  });

  const picksPerCategory = Object.entries(CATEGORIES).map(([name, arr]) => {
    const cleaned = arr.filter((e) => !BLACKLIST.has(e) && !isFlag(e));
    const take = Math.max(1, Math.ceil(cleaned.length / 3)); // 1/3（切り上げ、最低1）
    return shuffle(cleaned, rnd).slice(0, take);
  });

  const pool = shuffle(picksPerCategory.flat(), rnd);
  return { emojis: pool, emoji2cat, categories: CATEGORIES };
}

/**
 * sub 用に 2 つ選ぶ（カテゴリ重複なし & プール内）
 */
export function pickSubsFromPool(pool, rnd = Math.random) {
  const { emojis, emoji2cat } = pool;
  const shuffled = shuffle(emojis, rnd);
  let first = null,
    second = null;

  for (const e of shuffled) {
    if (!first) {
      first = e;
      continue;
    }
    if (emoji2cat[e] !== emoji2cat[first]) {
      second = e;
      break;
    }
  }
  if (!second) {
    for (const e of shuffled) {
      if (e !== first && emoji2cat[e] !== emoji2cat[first]) {
        second = e;
        break;
      }
    }
  }
  return [first, second].filter(Boolean);
}
